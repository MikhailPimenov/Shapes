CC=g++
CFLAGS=-Wall -Werror -Wextra -c

SOURCE_DIRECTORIES=Point Drawer Math Shape Shape/AngularShape Shape/Circle

DEPENDENCY_DIRECTORY=../dependencies
BUILD_DIRECTORY=../build

TARGET=$(BUILD_DIRECTORY)/Shapes.exe
TARGET_TEST=$(BUILD_DIRECTORY)/Shapes_test.exe


OBJECT_MAIN=$(BUILD_DIRECTORY)/Shapes.o
OBJECT_MAIN_TEST=$(BUILD_DIRECTORY)/Shapes_test.o


SOURCE_FILES_ALL=$(foreach directory_as_variable, $(SOURCE_DIRECTORIES),$(wildcard $(directory_as_variable)/*.cpp))
SOURCE_FILES=$(filter-out %_test.cpp, $(SOURCE_FILES_ALL))
SOURCE_FILES_TESTS=$(filter %_test.cpp, $(SOURCE_FILES_ALL))


OBJECT_FILES_ALL_IN_SOURCE_DIRECTORIES=$(patsubst %.cpp,%.o,$(SOURCE_FILES_ALL))
OBJECT_FILES_ALL_IN_BUILD_DIRECTORIES=$(addprefix $(BUILD_DIRECTORY)/,$(OBJECT_FILES_ALL_IN_SOURCE_DIRECTORIES))


OBJECT_FILES_TESTS_IN_SOURCE_DIRECTORIES=$(patsubst %.cpp,%.o,$(SOURCE_FILES_TESTS))
OBJECT_FILES_TESTS_IN_BUILD_DIRECTORIES=$(addprefix $(BUILD_DIRECTORY)/,$(OBJECT_FILES_TESTS_IN_SOURCE_DIRECTORIES))


OBJECT_FILES_IN_SOURCE_DIRECTORIES=$(patsubst %.cpp,%.o,$(SOURCE_FILES))
OBJECT_FILES_IN_BUILD_DIRECTORIES=$(addprefix $(BUILD_DIRECTORY)/,$(OBJECT_FILES_IN_SOURCE_DIRECTORIES))


DEPENDENCY_FILES_ALL_IN_SOURCE_DIRECTORIES=$(patsubst %.cpp,%.d,$(SOURCE_FILES_ALL))
DEPENDENCY_FILES_ALL_IN_DEPENDENCY_DIRECTORIES=$(addprefix $(DEPENDENCY_DIRECTORY)/,$(DEPENDENCY_FILES_ALL_IN_SOURCE_DIRECTORIES))
DEPENDENCY_FILES_ALL_IN_DEPENDENCY_DIRECTORIES+=$(DEPENDENCY_DIRECTORY)/Shapes.d


DEPENDENCY_DIRECTORIES=$(dir $(DEPENDENCY_FILES_ALL_IN_DEPENDENCY_DIRECTORIES))
DEPFLAGS=-MT $@ -MMD -MP -MF $(DEPENDENCY_DIRECTORY)/$*.d


run: all
		$(TARGET)


all: $(TARGET)


$(TARGET): $(OBJECT_FILES_IN_BUILD_DIRECTORIES) $(OBJECT_MAIN)
		$(CC) -o $@ $^


$(TARGET_TEST): $(OBJECT_FILES_IN_BUILD_DIRECTORIES) $(OBJECT_MAIN_TEST) $(OBJECT_FILES_TESTS_IN_BUILD_DIRECTORIES) 
		$(CC) -o $@ $^


$(OBJECT_MAIN): Shapes.cpp $(DEPENDENCY_DIRECTORY)/Shapes.d | $(DEPENDENCY_DIRECTORY)
		mkdir -p $(DEPENDENCY_DIRECTORY)/$(dir $*)
		$(CC) $(CFLAGS) -o $@ $< -MT $@ -MMD -MP -MF $(DEPENDENCY_DIRECTORY)/Shapes.d


$(OBJECT_MAIN_TEST): Shapes.cpp $(DEPENDENCY_DIRECTORY)/Shapes.d | $(DEPENDENCY_DIRECTORY)
		mkdir -p $(DEPENDENCY_DIRECTORY)/$(dir $*)
		$(CC) $(CFLAGS) -D TEST_GRAPH_ -o $@ $<  -MT $@ -MMD -MP -MF $(DEPENDENCY_DIRECTORY)/Shapes.d


$(OBJECT_FILES_ALL_IN_BUILD_DIRECTORIES): $(BUILD_DIRECTORY)/%.o: %.cpp $(DEPENDENCY_DIRECTORY)/%.d | $(DEPENDENCY_DIRECTORY)
		mkdir -p $(dir $@)
		mkdir -p $(DEPENDENCY_DIRECTORY)/$(dir $*)
		$(CC) $(CFLAGS) $< -o $@ $(DEPFLAGS)


$(DEPENDENCY_DIRECTORY):
		mkdir -p $(DEPENDENCY_DIRECTORY)


$(DEPENDENCY_FILES_ALL_IN_DEPENDENCY_DIRECTORIES):


clean: 
		rm -rf $(BUILD_DIRECTORY)/* $(DEPENDENCY_DIRECTORY)/*


include $(wildcard $(DEPENDENCY_FILES_ALL_IN_DEPENDENCY_DIRECTORIES))